# å›¾ç‰‡æ‹–æ‹½æ’åºåŠŸèƒ½è®¾è®¡æ–¹æ¡ˆ

## éœ€æ±‚æè¿°

ç”¨æˆ·ä¸Šä¼ å¤šå¼ å‚è€ƒå›¾ç‰‡åï¼Œå¯ä»¥é€šè¿‡é•¿æŒ‰æ‹–åŠ¨çš„æ–¹å¼è°ƒæ•´å›¾ç‰‡é¡ºåºï¼Œå›¾ç‰‡é¡ºåºä¼šå½±å“ API è°ƒç”¨æ—¶ä¼ é€’ç»™ Gemini çš„é¡ºåºã€‚

## æŠ€æœ¯æ–¹æ¡ˆ

### æ–¹æ¡ˆé€‰æ‹©

é‡‡ç”¨ **HTML5 Drag and Drop API** å®ç°ï¼ŒåŸå› ï¼š
- âœ… æ— éœ€é¢å¤–ä¾èµ–ï¼Œä¿æŒé¡¹ç›®è½»é‡
- âœ… æµè§ˆå™¨åŸç”Ÿæ”¯æŒï¼Œæ€§èƒ½å¥½
- âœ… å®ç°ç®€å•ï¼Œä»£ç é‡å°‘
- âš ï¸ ç§»åŠ¨ç«¯æ”¯æŒéœ€è¦é¢å¤–å¤„ç†ï¼ˆå¯åç»­ä¼˜åŒ–ï¼‰

### å®ç°æ­¥éª¤

#### 1. æ·»åŠ æ‹–æ‹½çŠ¶æ€

åœ¨ [`App.tsx`](image-gen-app/src/App.tsx) ä¸­æ·»åŠ çŠ¶æ€ï¼š

```typescript
const [draggedIndex, setDraggedIndex] = useState<number | null>(null)
```

#### 2. å®ç°æ‹–æ‹½å¤„ç†å‡½æ•°

```typescript
// å¼€å§‹æ‹–æ‹½
function handleDragStart(index: number) {
  setDraggedIndex(index)
}

// æ‹–æ‹½ç»è¿‡
function handleDragOver(e: React.DragEvent, index: number) {
  e.preventDefault()
  
  if (draggedIndex === null || draggedIndex === index) return
  
  // äº¤æ¢ä½ç½®
  const newImages = [...inputImages]
  const draggedItem = newImages[draggedIndex]
  newImages.splice(draggedIndex, 1)
  newImages.splice(index, 0, draggedItem)
  
  setInputImages(newImages)
  setDraggedIndex(index)
}

// ç»“æŸæ‹–æ‹½
function handleDragEnd() {
  setDraggedIndex(null)
}
```

#### 3. ä¿®æ”¹å›¾ç‰‡é¡¹æ¸²æŸ“

åœ¨ [`App.tsx`](image-gen-app/src/App.tsx:267-280) çš„å›¾ç‰‡é¡¹ä¸­æ·»åŠ æ‹–æ‹½å±æ€§ï¼š

```tsx
<div 
  key={index} 
  className={`imageItem ${draggedIndex === index ? 'dragging' : ''}`}
  draggable
  onDragStart={() => handleDragStart(index)}
  onDragOver={(e) => handleDragOver(e, index)}
  onDragEnd={handleDragEnd}
>
  <img src={img.previewUrl} alt={img.fileName} />
  <div className="fileName">{img.fileName}</div>
  <button onClick={() => {
    setInputImages(prev => prev.filter((_, i) => i !== index))
    if (inputImages.length === 1 && fileInputRef.current) {
      fileInputRef.current.value = ''
    }
  }} className="removeBtn">âœ•</button>
</div>
```

#### 4. æ·»åŠ  CSS æ ·å¼

åœ¨ [`styles.css`](image-gen-app/src/styles.css) ä¸­æ·»åŠ æ‹–æ‹½æ ·å¼ï¼š

```css
.imageItem {
  cursor: grab;
  transition: opacity 0.2s, transform 0.2s;
}

.imageItem:active {
  cursor: grabbing;
}

.imageItem.dragging {
  opacity: 0.5;
  transform: scale(0.95);
}

.imageItem:hover {
  transform: scale(1.02);
}
```

## äº¤äº’æµç¨‹

```mermaid
graph TD
    A[ç”¨æˆ·é•¿æŒ‰å›¾ç‰‡] --> B[è§¦å‘ dragStart]
    B --> C[è®¾ç½® draggedIndex]
    C --> D[æ‹–åŠ¨åˆ°å…¶ä»–å›¾ç‰‡ä¸Šæ–¹]
    D --> E[è§¦å‘ dragOver]
    E --> F[äº¤æ¢å›¾ç‰‡ä½ç½®]
    F --> G[æ›´æ–° draggedIndex]
    G --> H{ç»§ç»­æ‹–åŠ¨?}
    H -->|æ˜¯| D
    H -->|å¦| I[é‡Šæ”¾é¼ æ ‡]
    I --> J[è§¦å‘ dragEnd]
    J --> K[æ¸…é™¤ draggedIndex]
    K --> L[å®Œæˆæ’åº]
```

## è§†è§‰åé¦ˆ

1. **æ‹–æ‹½å‰**ï¼šé¼ æ ‡æ‚¬åœæ—¶å›¾ç‰‡è½»å¾®æ”¾å¤§ï¼ˆscale 1.02ï¼‰
2. **æ‹–æ‹½ä¸­**ï¼šè¢«æ‹–æ‹½çš„å›¾ç‰‡åŠé€æ˜ï¼ˆopacity 0.5ï¼‰+ ç¼©å°ï¼ˆscale 0.95ï¼‰
3. **æ‹–æ‹½å**ï¼šæ¢å¤æ­£å¸¸çŠ¶æ€

## ä¼˜åŒ–å»ºè®®

### çŸ­æœŸä¼˜åŒ–
- âœ… æ·»åŠ æ‹–æ‹½æ‰‹æŸ„å›¾æ ‡ï¼ˆå¯é€‰ï¼‰
- âœ… æ·»åŠ æ‹–æ‹½æ—¶çš„è¾¹æ¡†é«˜äº®

### é•¿æœŸä¼˜åŒ–
- ğŸ”„ æ·»åŠ ç§»åŠ¨ç«¯è§¦æ‘¸æ”¯æŒï¼ˆä½¿ç”¨ touch eventsï¼‰
- ğŸ”„ æ·»åŠ æ‹–æ‹½åŠ¨ç”»è¿‡æ¸¡æ•ˆæœ
- ğŸ”„ æ·»åŠ æ‹–æ‹½é¢„è§ˆï¼ˆghost imageï¼‰

## ä»£ç ä¿®æ”¹æ¸…å•

### æ–‡ä»¶ï¼š[`App.tsx`](image-gen-app/src/App.tsx)

**ä¿®æ”¹ä½ç½® 1**ï¼šæ·»åŠ çŠ¶æ€ï¼ˆç¬¬ 77 è¡Œåï¼‰
```typescript
const [draggedIndex, setDraggedIndex] = useState<number | null>(null)
```

**ä¿®æ”¹ä½ç½® 2**ï¼šæ·»åŠ å¤„ç†å‡½æ•°ï¼ˆç¬¬ 173 è¡Œåï¼‰
```typescript
function handleDragStart(index: number) {
  setDraggedIndex(index)
}

function handleDragOver(e: React.DragEvent, index: number) {
  e.preventDefault()
  if (draggedIndex === null || draggedIndex === index) return
  
  const newImages = [...inputImages]
  const draggedItem = newImages[draggedIndex]
  newImages.splice(draggedIndex, 1)
  newImages.splice(index, 0, draggedItem)
  
  setInputImages(newImages)
  setDraggedIndex(index)
}

function handleDragEnd() {
  setDraggedIndex(null)
}
```

**ä¿®æ”¹ä½ç½® 3**ï¼šä¿®æ”¹å›¾ç‰‡é¡¹ï¼ˆç¬¬ 269 è¡Œï¼‰
```tsx
<div 
  key={index} 
  className={`imageItem ${draggedIndex === index ? 'dragging' : ''}`}
  draggable
  onDragStart={() => handleDragStart(index)}
  onDragOver={(e) => handleDragOver(e, index)}
  onDragEnd={handleDragEnd}
>
```

### æ–‡ä»¶ï¼š[`styles.css`](image-gen-app/src/styles.css)

**ä¿®æ”¹ä½ç½®**ï¼šåœ¨ `.imageItem` æ ·å¼ä¸­æ·»åŠ ï¼ˆç¬¬ 522 è¡Œåï¼‰
```css
.imageItem {
  position: relative;
  aspect-ratio: 1;
  border-radius: 8px;
  overflow: hidden;
  border: 1px solid var(--border);
  cursor: grab;
  transition: opacity 0.2s, transform 0.2s;
}

.imageItem:active {
  cursor: grabbing;
}

.imageItem.dragging {
  opacity: 0.5;
  transform: scale(0.95);
}

.imageItem:hover {
  transform: scale(1.02);
}
```

## æµ‹è¯•è¦ç‚¹

1. âœ… æ‹–æ‹½å•å¼ å›¾ç‰‡åˆ°ä¸åŒä½ç½®
2. âœ… æ‹–æ‹½å¤šå¼ å›¾ç‰‡éªŒè¯é¡ºåºæ­£ç¡®
3. âœ… æ‹–æ‹½åç”Ÿæˆå›¾ç‰‡ï¼ŒéªŒè¯ API è°ƒç”¨é¡ºåºæ­£ç¡®
4. âœ… åˆ é™¤å›¾ç‰‡åæ‹–æ‹½åŠŸèƒ½æ­£å¸¸
5. âœ… è§†è§‰åé¦ˆæµç•…è‡ªç„¶

## å®ç°ä¼˜å…ˆçº§

**P0ï¼ˆå¿…é¡»ï¼‰**ï¼š
- [x] åŸºç¡€æ‹–æ‹½æ’åºåŠŸèƒ½
- [x] è§†è§‰åé¦ˆï¼ˆé€æ˜åº¦ã€ç¼©æ”¾ï¼‰
- [x] æ‹–æ‹½çŠ¶æ€ç®¡ç†

**P1ï¼ˆå»ºè®®ï¼‰**ï¼š
- [ ] ç§»åŠ¨ç«¯è§¦æ‘¸æ”¯æŒ
- [ ] æ‹–æ‹½åŠ¨ç”»ä¼˜åŒ–

**P2ï¼ˆå¯é€‰ï¼‰**ï¼š
- [ ] æ‹–æ‹½æ‰‹æŸ„
- [ ] è‡ªå®šä¹‰æ‹–æ‹½é¢„è§ˆ
