# å†å²è®°å½•åŠŸèƒ½è®¾è®¡æ–¹æ¡ˆ

## éœ€æ±‚æ¦‚è¿°

ä¸ºé›¶ç•Œè®¾è®¡åº”ç”¨æ·»åŠ ç”Ÿæˆå›¾ç‰‡çš„å†å²è®°å½•åŠŸèƒ½ï¼Œè¦æ±‚ï¼š
- âœ… çº¯å‰ç«¯å®ç°ï¼ˆæ— éœ€æœåŠ¡å™¨ï¼‰
- âœ… å¯éƒ¨ç½²åœ¨ EdgeOne é™æ€æ‰˜ç®¡
- âœ… æ”¯æŒæŸ¥çœ‹ã€ç®¡ç†ã€é‡æ–°ç”Ÿæˆå†å²å›¾ç‰‡

## æŠ€æœ¯æ–¹æ¡ˆ

### æ•°æ®å­˜å‚¨ï¼šIndexedDB

**ä¸ºä»€ä¹ˆé€‰æ‹© IndexedDBï¼Ÿ**
- localStorage é™åˆ¶çº¦ 5-10MBï¼Œæ— æ³•å­˜å‚¨å¤§é‡å›¾ç‰‡
- IndexedDB å­˜å‚¨å®¹é‡å¤§ï¼ˆè¯¦è§ä¸‹æ–¹æµè§ˆå™¨é™åˆ¶è¯´æ˜ï¼‰ï¼Œé€‚åˆå­˜å‚¨å›¾ç‰‡
- æ”¯æŒå¼‚æ­¥æ“ä½œï¼Œä¸é˜»å¡ UI

**æµè§ˆå™¨å­˜å‚¨é™åˆ¶è¯¦è§£**ï¼š

ä¸åŒæµè§ˆå™¨å¯¹ IndexedDB çš„å­˜å‚¨é™åˆ¶ä¸åŒï¼š

| æµè§ˆå™¨ | å­˜å‚¨é™åˆ¶ | è¯´æ˜ |
|--------|---------|------|
| **Chrome/Edge** | å¯ç”¨ç£ç›˜ç©ºé—´çš„ 60% | åŠ¨æ€åˆ†é…ï¼Œé€šå¸¸å¯è¾¾æ•° GB |
| **Firefox** | å¯ç”¨ç£ç›˜ç©ºé—´çš„ 50% | æœ€å¤§ 2GBï¼ˆå¯é€šè¿‡è®¾ç½®å¢åŠ ï¼‰ |
| **Safari** | çº¦ 1GB | è¶…è¿‡é™åˆ¶ä¼šæç¤ºç”¨æˆ·æˆæƒ |
| **ç§»åŠ¨æµè§ˆå™¨** | çº¦ 50-500MB | å—è®¾å¤‡å­˜å‚¨ç©ºé—´é™åˆ¶ |

**å®é™…å­˜å‚¨å®¹é‡ä¼°ç®—**ï¼š

å‡è®¾ç”Ÿæˆ 2K åˆ†è¾¨ç‡çš„å›¾ç‰‡ï¼š
- å•å¼ å›¾ç‰‡å¤§å°ï¼šçº¦ 500KB - 2MBï¼ˆå–å†³äºå‹ç¼©ç‡ï¼‰
- 100 æ¡å†å²è®°å½•ï¼šçº¦ 50MB - 200MB
- å»ºè®®é™åˆ¶ï¼šæœ€å¤šä¿å­˜ 100-200 æ¡å†å²è®°å½•

**å­˜å‚¨ç­–ç•¥**ï¼š
- è‡ªåŠ¨æ¸…ç†è¶…è¿‡ 100 æ¡çš„æ—§è®°å½•
- ä½¿ç”¨ç¼©ç•¥å›¾å‡å°‘å­˜å‚¨ç©ºé—´ï¼ˆç¼©ç•¥å›¾çº¦ 50KBï¼‰
- æä¾›å¯¼å‡ºåŠŸèƒ½ï¼Œç”¨æˆ·å¯å¤‡ä»½åæ¸…ç†

**æ•°æ®åº“è®¾è®¡**ï¼š
```typescript
æ•°æ®åº“åï¼šImageGenHistory
ç‰ˆæœ¬ï¼š1
å¯¹è±¡å­˜å‚¨ï¼šhistory
ç´¢å¼•ï¼š
  - timestampï¼ˆæŒ‰æ—¶é—´æ’åºï¼‰
  - modeï¼ˆæŒ‰æ¨¡å¼ç­›é€‰ï¼‰
```

### æ•°æ®ç»“æ„

```typescript
type HistoryItem = {
  id: string                    // UUID
  timestamp: number             // æ—¶é—´æˆ³
  mode: 'generate' | 'workflow' // ç”Ÿæˆæ¨¡å¼
  
  // ç”Ÿæˆå‚æ•°
  prompt: string                // æç¤ºè¯
  aspectRatio: string           // å®½é«˜æ¯”
  imageSize?: '1K' | '2K' | '4K' // åˆ†è¾¨ç‡
  workflowId?: string           // å·¥ä½œæµ ID
  workflowName?: string         // å·¥ä½œæµåç§°
  
  // å›¾ç‰‡æ•°æ®
  imageData: string             // base64 å®Œæ•´å›¾ç‰‡
  mimeType: string              // å›¾ç‰‡ç±»å‹
  thumbnailData?: string        // ç¼©ç•¥å›¾ï¼ˆå¯é€‰ä¼˜åŒ–ï¼‰
  
  // è¾“å…¥å›¾ç‰‡ï¼ˆå¯é€‰ï¼‰
  inputImages?: Array<{
    mimeType: string
    base64Data: string
  }>
  
  // å…ƒæ•°æ®
  generationTime?: number       // ç”Ÿæˆè€—æ—¶ï¼ˆç§’ï¼‰
}
```

## UI è®¾è®¡

### å¸ƒå±€æ–¹æ¡ˆï¼šæ–°å¢å†å²è®°å½•æ ‡ç­¾é¡µ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Logo  [ç”Ÿå›¾] [å·¥ä½œæµ] [å†å²è®°å½•]    âš™ï¸ è®¾ç½®  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                             â”‚
â”‚  å†å²è®°å½•é¡µé¢                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ ğŸ” æœç´¢  ğŸ“… ç­›é€‰  ğŸ—‘ï¸ æ¸…ç©ºå…¨éƒ¨       â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚ å›¾ç‰‡1  â”‚ â”‚ å›¾ç‰‡2  â”‚ â”‚ å›¾ç‰‡3  â”‚         â”‚
â”‚  â”‚ æç¤ºè¯ â”‚ â”‚ æç¤ºè¯ â”‚ â”‚ æç¤ºè¯ â”‚         â”‚
â”‚  â”‚ æ—¶é—´   â”‚ â”‚ æ—¶é—´   â”‚ â”‚ æ—¶é—´   â”‚         â”‚
â”‚  â”‚ [æ“ä½œ] â”‚ â”‚ [æ“ä½œ] â”‚ â”‚ [æ“ä½œ] â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å†å²è®°å½•å¡ç‰‡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      â”‚
â”‚   [ç¼©ç•¥å›¾é¢„è§ˆ]       â”‚
â”‚                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ æç¤ºè¯ï¼šCreate a... â”‚
â”‚ æ¨¡å¼ï¼šç”Ÿå›¾æ¨¡å¼       â”‚
â”‚ åˆ†è¾¨ç‡ï¼š2K (9:16)   â”‚
â”‚ æ—¶é—´ï¼š2åˆ†é’Ÿå‰        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ [æŸ¥çœ‹] [é‡ç”Ÿæˆ] [åˆ é™¤]â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å†å²è¯¦æƒ…æ¨¡æ€æ¡†

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å†å²è®°å½•è¯¦æƒ…              [âœ•]  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                 â”‚
â”‚     [å¤§å›¾é¢„è§ˆ]                  â”‚
â”‚                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ğŸ“ æç¤ºè¯ï¼š                     â”‚
â”‚    Create a picture of...       â”‚
â”‚                                 â”‚
â”‚ âš™ï¸ å‚æ•°ï¼š                       â”‚
â”‚    æ¨¡å¼ï¼šç”Ÿå›¾æ¨¡å¼               â”‚
â”‚    å®½é«˜æ¯”ï¼š9:16                 â”‚
â”‚    åˆ†è¾¨ç‡ï¼š2K (1536x2752)       â”‚
â”‚    ç”Ÿæˆæ—¶é—´ï¼š2024-12-24 20:00   â”‚
â”‚    è€—æ—¶ï¼š45ç§’                   â”‚
â”‚                                 â”‚
â”‚ ğŸ–¼ï¸ å‚è€ƒå›¾ç‰‡ï¼š                   â”‚
â”‚    [ç¼©ç•¥å›¾1] [ç¼©ç•¥å›¾2]          â”‚
â”‚                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ [é‡æ–°ç”Ÿæˆ] [ä¸‹è½½] [åˆ é™¤] [å…³é—­] â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## åŠŸèƒ½ç‰¹æ€§

### 1. è‡ªåŠ¨ä¿å­˜å†å²è®°å½•

**è§¦å‘æ—¶æœº**ï¼šå›¾ç‰‡ç”ŸæˆæˆåŠŸå
**ä¿å­˜å†…å®¹**ï¼š
- ç”Ÿæˆçš„å›¾ç‰‡ï¼ˆbase64ï¼‰
- æ‰€æœ‰ç”Ÿæˆå‚æ•°
- è¾“å…¥çš„å‚è€ƒå›¾ç‰‡ï¼ˆå¦‚æœæœ‰ï¼‰
- æ—¶é—´æˆ³å’Œå…ƒæ•°æ®

**å®ç°ä½ç½®**ï¼š[`App.tsx:onGenerate()`](image-gen-app/src/App.tsx:235)

```typescript
// åœ¨ç”ŸæˆæˆåŠŸåæ·»åŠ 
const historyItem: HistoryItem = {
  id: crypto.randomUUID(),
  timestamp: Date.now(),
  mode,
  prompt: finalPrompt,
  aspectRatio,
  imageSize: imageSize.imageSize,
  workflowId: selectedWorkflow?.id,
  workflowName: selectedWorkflow?.name,
  imageData: img.base64Data,
  mimeType: img.mimeType,
  inputImages: inputImages.length > 0 ? inputImages : undefined,
  generationTime
}

await saveHistory(historyItem)
```

### 2. æŸ¥çœ‹å†å²è®°å½•

**å±•ç¤ºæ–¹å¼**ï¼š
- ç½‘æ ¼å¸ƒå±€ï¼ˆå“åº”å¼ï¼š1-4åˆ—ï¼‰
- æŒ‰æ—¶é—´å€’åºæ’åˆ—ï¼ˆæœ€æ–°çš„åœ¨å‰ï¼‰
- æ˜¾ç¤ºç¼©ç•¥å›¾ã€æç¤ºè¯æ‘˜è¦ã€æ—¶é—´

**åŠ è½½ç­–ç•¥**ï¼š
- åˆå§‹åŠ è½½æœ€è¿‘ 20 æ¡
- æ»šåŠ¨åŠ è½½æ›´å¤šï¼ˆæ‡’åŠ è½½ï¼‰

### 3. æœç´¢å’Œç­›é€‰

**æœç´¢**ï¼š
- æŒ‰æç¤ºè¯å†…å®¹æœç´¢
- å®æ—¶æœç´¢ï¼ˆé˜²æŠ–ï¼‰

**ç­›é€‰**ï¼š
- æŒ‰æ¨¡å¼ç­›é€‰ï¼ˆç”Ÿå›¾/å·¥ä½œæµï¼‰
- æŒ‰æ—¥æœŸèŒƒå›´ç­›é€‰ï¼ˆä»Šå¤©/æœ¬å‘¨/æœ¬æœˆ/å…¨éƒ¨ï¼‰
- æŒ‰åˆ†è¾¨ç‡ç­›é€‰

### 4. é‡æ–°ç”Ÿæˆ

**åŠŸèƒ½**ï¼š
- ç‚¹å‡»"é‡æ–°ç”Ÿæˆ"æŒ‰é’®
- è‡ªåŠ¨å¡«å……å†å²è®°å½•çš„å‚æ•°åˆ°ç”Ÿå›¾/å·¥ä½œæµæ¨¡å¼
- åˆ‡æ¢åˆ°å¯¹åº”çš„æ¨¡å¼æ ‡ç­¾é¡µ
- ç”¨æˆ·å¯ä»¥ä¿®æ”¹å‚æ•°åå†ç”Ÿæˆ

**å®ç°é€»è¾‘**ï¼š
```typescript
function regenerateFromHistory(item: HistoryItem) {
  // åˆ‡æ¢æ¨¡å¼
  setMode(item.mode)
  
  // å¡«å……å‚æ•°
  setPrompt(item.prompt)
  setAspectRatio(item.aspectRatio)
  setImageSize(SIZE_OPTIONS.find(s => s.imageSize === item.imageSize) || SIZE_OPTIONS[0])
  
  // å¦‚æœæ˜¯å·¥ä½œæµæ¨¡å¼ï¼Œé€‰æ‹©å¯¹åº”çš„å·¥ä½œæµ
  if (item.mode === 'workflow' && item.workflowId) {
    const workflow = WORKFLOW_TEMPLATES.find(w => w.id === item.workflowId)
    setSelectedWorkflow(workflow || null)
  }
  
  // æ¢å¤è¾“å…¥å›¾ç‰‡
  if (item.inputImages) {
    setInputImages(item.inputImages.map((img, index) => ({
      ...img,
      previewUrl: `data:${img.mimeType};base64,${img.base64Data}`,
      fileName: `history-input-${index + 1}.png`
    })))
  }
}
```

### 5. åˆ é™¤è®°å½•

**å•ä¸ªåˆ é™¤**ï¼š
- å¡ç‰‡ä¸Šçš„åˆ é™¤æŒ‰é’®
- ç¡®è®¤å¯¹è¯æ¡†

**æ‰¹é‡åˆ é™¤**ï¼š
- å¤šé€‰æ¨¡å¼
- æ‰¹é‡åˆ é™¤æŒ‰é’®

**æ¸…ç©ºå…¨éƒ¨**ï¼š
- é¡¶éƒ¨"æ¸…ç©ºå…¨éƒ¨"æŒ‰é’®
- äºŒæ¬¡ç¡®è®¤å¯¹è¯æ¡†

### 6. å¯¼å‡ºå›¾ç‰‡

**å•ä¸ªå¯¼å‡º**ï¼š
- ä¸‹è½½æŒ‰é’®ï¼Œä¿å­˜ä¸º PNG
- æ–‡ä»¶åï¼š`generated_[timestamp].png`

**æ‰¹é‡å¯¼å‡º**ï¼š
- å¤šé€‰åæ‰¹é‡ä¸‹è½½
- æ‰“åŒ…ä¸º ZIPï¼ˆå¯é€‰ï¼Œéœ€è¦ JSZip åº“ï¼‰

### 7. å­˜å‚¨ç®¡ç†

**æ˜¾ç¤ºå­˜å‚¨ä¿¡æ¯**ï¼š
- å·²ç”¨ç©ºé—´ / æ€»ç©ºé—´
- å†å²è®°å½•æ•°é‡

**æ¸…ç†ç­–ç•¥**ï¼š
- è‡ªåŠ¨æ¸…ç†è¶…è¿‡ 100 æ¡çš„æ—§è®°å½•
- ç”¨æˆ·æ‰‹åŠ¨æ¸…ç†

## å®ç°æ­¥éª¤

### æ­¥éª¤ 1ï¼šåˆ›å»º IndexedDB å·¥å…·ç±»

**æ–‡ä»¶**ï¼š`src/historyDB.ts`

```typescript
// æ•°æ®åº“é…ç½®
const DB_NAME = 'ImageGenHistory'
const DB_VERSION = 1
const STORE_NAME = 'history'

// åˆå§‹åŒ–æ•°æ®åº“
export async function initDB(): Promise<IDBDatabase>

// ä¿å­˜å†å²è®°å½•
export async function saveHistory(item: HistoryItem): Promise<void>

// è·å–å†å²è®°å½•åˆ—è¡¨
export async function getHistory(limit?: number, offset?: number): Promise<HistoryItem[]>

// è·å–å•æ¡å†å²è®°å½•
export async function getHistoryById(id: string): Promise<HistoryItem | null>

// åˆ é™¤å†å²è®°å½•
export async function deleteHistory(id: string): Promise<void>

// æ‰¹é‡åˆ é™¤
export async function deleteHistoryBatch(ids: string[]): Promise<void>

// æ¸…ç©ºå…¨éƒ¨
export async function clearHistory(): Promise<void>

// è·å–å­˜å‚¨å¤§å°ï¼ˆä¼°ç®—ï¼‰
export async function getStorageSize(): Promise<number>

// æœç´¢å†å²è®°å½•
export async function searchHistory(keyword: string): Promise<HistoryItem[]>
```

### æ­¥éª¤ 2ï¼šåˆ›å»ºå†å²è®°å½•ç»„ä»¶

**æ–‡ä»¶**ï¼š`src/HistoryView.tsx`

```typescript
export function HistoryView() {
  const [historyItems, setHistoryItems] = useState<HistoryItem[]>([])
  const [loading, setLoading] = useState(true)
  const [searchKeyword, setSearchKeyword] = useState('')
  const [filterMode, setFilterMode] = useState<'all' | 'generate' | 'workflow'>('all')
  
  // åŠ è½½å†å²è®°å½•
  useEffect(() => {
    loadHistory()
  }, [])
  
  async function loadHistory() {
    const items = await getHistory(20)
    setHistoryItems(items)
    setLoading(false)
  }
  
  // æœç´¢
  async function handleSearch(keyword: string) {
    if (keyword) {
      const results = await searchHistory(keyword)
      setHistoryItems(results)
    } else {
      loadHistory()
    }
  }
  
  // åˆ é™¤
  async function handleDelete(id: string) {
    if (confirm('ç¡®å®šåˆ é™¤è¿™æ¡å†å²è®°å½•å—ï¼Ÿ')) {
      await deleteHistory(id)
      loadHistory()
    }
  }
  
  // æ¸…ç©ºå…¨éƒ¨
  async function handleClearAll() {
    if (confirm('ç¡®å®šæ¸…ç©ºæ‰€æœ‰å†å²è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
      await clearHistory()
      loadHistory()
    }
  }
  
  return (
    <div className="historyView">
      {/* é¡¶éƒ¨å·¥å…·æ  */}
      <div className="historyToolbar">
        <input 
          type="text" 
          placeholder="æœç´¢æç¤ºè¯..." 
          value={searchKeyword}
          onChange={(e) => {
            setSearchKeyword(e.target.value)
            handleSearch(e.target.value)
          }}
        />
        <select value={filterMode} onChange={(e) => setFilterMode(e.target.value as any)}>
          <option value="all">å…¨éƒ¨æ¨¡å¼</option>
          <option value="generate">ç”Ÿå›¾æ¨¡å¼</option>
          <option value="workflow">å·¥ä½œæµæ¨¡å¼</option>
        </select>
        <button onClick={handleClearAll}>ğŸ—‘ï¸ æ¸…ç©ºå…¨éƒ¨</button>
      </div>
      
      {/* å†å²è®°å½•ç½‘æ ¼ */}
      <div className="historyGrid">
        {historyItems.map(item => (
          <HistoryCard 
            key={item.id} 
            item={item}
            onDelete={handleDelete}
            onRegenerate={onRegenerate}
          />
        ))}
      </div>
    </div>
  )
}
```

**æ–‡ä»¶**ï¼š`src/HistoryCard.tsx`

```typescript
export function HistoryCard({ 
  item, 
  onDelete, 
  onRegenerate 
}: { 
  item: HistoryItem
  onDelete: (id: string) => void
  onRegenerate: (item: HistoryItem) => void
}) {
  const [showDetail, setShowDetail] = useState(false)
  
  return (
    <>
      <div className="historyCard">
        <img 
          src={`data:${item.mimeType};base64,${item.imageData}`}
          alt="å†å²å›¾ç‰‡"
          onClick={() => setShowDetail(true)}
        />
        <div className="historyCardInfo">
          <div className="historyPrompt">{truncate(item.prompt, 50)}</div>
          <div className="historyMeta">
            <span>{item.mode === 'generate' ? 'ç”Ÿå›¾' : item.workflowName}</span>
            <span>{item.imageSize || 'é»˜è®¤'} ({item.aspectRatio})</span>
          </div>
          <div className="historyTime">{formatTime(item.timestamp)}</div>
        </div>
        <div className="historyActions">
          <button onClick={() => setShowDetail(true)}>æŸ¥çœ‹</button>
          <button onClick={() => onRegenerate(item)}>é‡ç”Ÿæˆ</button>
          <button onClick={() => onDelete(item.id)}>åˆ é™¤</button>
        </div>
      </div>
      
      {showDetail && (
        <HistoryDetailModal 
          item={item}
          onClose={() => setShowDetail(false)}
          onRegenerate={onRegenerate}
          onDelete={onDelete}
        />
      )}
    </>
  )
}
```

### æ­¥éª¤ 3ï¼šé›†æˆåˆ°ä¸»åº”ç”¨

**ä¿®æ”¹ [`App.tsx`](image-gen-app/src/App.tsx:130)**ï¼š

```typescript
type AppMode = 'generate' | 'workflow' | 'history'

const [mode, setMode] = useState<AppMode>('generate')

// åœ¨ onGenerate æˆåŠŸåä¿å­˜å†å²
const historyItem: HistoryItem = {
  id: crypto.randomUUID(),
  timestamp: Date.now(),
  mode,
  prompt: finalPrompt,
  aspectRatio,
  imageSize: imageSize.imageSize,
  workflowId: selectedWorkflow?.id,
  workflowName: selectedWorkflow?.name,
  imageData: img.base64Data,
  mimeType: img.mimeType,
  inputImages: inputImages.length > 0 ? inputImages.map(img => ({
    mimeType: img.mimeType,
    base64Data: img.base64Data
  })) : undefined,
  generationTime
}

await saveHistory(historyItem)

// æ·»åŠ å†å²è®°å½•æ ‡ç­¾é¡µ
<div className="modeTabs">
  <button className={`modeTab ${mode === 'generate' ? 'active' : ''}`} onClick={() => setMode('generate')}>
    ğŸ¨ ç”Ÿå›¾æ¨¡å¼
  </button>
  <button className={`modeTab ${mode === 'workflow' ? 'active' : ''}`} onClick={() => setMode('workflow')}>
    ğŸ”„ å·¥ä½œæµæ¨¡å¼
  </button>
  <button className={`modeTab ${mode === 'history' ? 'active' : ''}`} onClick={() => setMode('history')}>
    ğŸ“œ å†å²è®°å½•
  </button>
</div>

// æ¸²æŸ“å†å²è®°å½•é¡µé¢
{mode === 'history' && (
  <HistoryView onRegenerate={regenerateFromHistory} />
)}
```

### æ­¥éª¤ 4ï¼šæ·»åŠ æ ·å¼

**æ–‡ä»¶**ï¼š[`src/styles.css`](image-gen-app/src/styles.css:1)

```css
/* å†å²è®°å½•é¡µé¢ */
.historyView {
  padding: 20px;
  max-width: 1400px;
  margin: 0 auto;
}

.historyToolbar {
  display: flex;
  gap: 12px;
  margin-bottom: 20px;
  flex-wrap: wrap;
}

.historyToolbar input {
  flex: 1;
  min-width: 200px;
}

.historyGrid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
  gap: 16px;
}

.historyCard {
  background: var(--panel);
  border: 1px solid var(--border);
  border-radius: 12px;
  overflow: hidden;
  transition: transform 0.2s;
}

.historyCard:hover {
  transform: translateY(-4px);
  box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
}

.historyCard img {
  width: 100%;
  aspect-ratio: 1;
  object-fit: cover;
  cursor: pointer;
}

.historyCardInfo {
  padding: 12px;
}

.historyPrompt {
  font-size: 14px;
  color: var(--text);
  margin-bottom: 8px;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.historyMeta {
  display: flex;
  gap: 8px;
  font-size: 12px;
  color: var(--muted);
  margin-bottom: 4px;
}

.historyTime {
  font-size: 12px;
  color: var(--muted2);
}

.historyActions {
  display: flex;
  gap: 8px;
  padding: 12px;
  border-top: 1px solid var(--border);
}

.historyActions button {
  flex: 1;
  padding: 6px 12px;
  font-size: 13px;
}
```

## æ€§èƒ½ä¼˜åŒ–

### 1. ç¼©ç•¥å›¾ç”Ÿæˆ

ä¸ºäº†æå‡åˆ—è¡¨åŠ è½½é€Ÿåº¦ï¼Œå¯ä»¥ç”Ÿæˆç¼©ç•¥å›¾ï¼š

```typescript
function generateThumbnail(base64Data: string, maxWidth: number = 400): Promise<string> {
  return new Promise((resolve) => {
    const img = new Image()
    img.onload = () => {
      const canvas = document.createElement('canvas')
      const scale = maxWidth / img.width
      canvas.width = maxWidth
      canvas.height = img.height * scale
      
      const ctx = canvas.getContext('2d')!
      ctx.drawImage(img, 0, 0, canvas.width, canvas.height)
      
      resolve(canvas.toDataURL('image/jpeg', 0.7))
    }
    img.src = `data:image/png;base64,${base64Data}`
  })
}
```

### 2. æ‡’åŠ è½½

ä½¿ç”¨ Intersection Observer å®ç°æ»šåŠ¨åŠ è½½ï¼š

```typescript
const observer = new IntersectionObserver((entries) => {
  entries.forEach(entry => {
    if (entry.isIntersecting) {
      loadMoreHistory()
    }
  })
})
```

### 3. è™šæ‹Ÿæ»šåŠ¨

å¦‚æœå†å²è®°å½•è¶…è¿‡ 100 æ¡ï¼Œè€ƒè™‘ä½¿ç”¨è™šæ‹Ÿæ»šåŠ¨åº“ï¼ˆå¦‚ react-windowï¼‰ã€‚

## å­˜å‚¨é™åˆ¶å¤„ç†

### è‡ªåŠ¨æ¸…ç†ç­–ç•¥

```typescript
async function checkStorageLimit() {
  const items = await getHistory()
  
  // å¦‚æœè¶…è¿‡ 100 æ¡ï¼Œåˆ é™¤æœ€æ—§çš„è®°å½•
  if (items.length > 100) {
    const toDelete = items.slice(100)
    await deleteHistoryBatch(toDelete.map(item => item.id))
  }
}
```

### ç”¨æˆ·æç¤º

å½“å­˜å‚¨æ¥è¿‘é™åˆ¶æ—¶ï¼Œæ˜¾ç¤ºæç¤ºï¼š

```typescript
const storageSize = await getStorageSize()
const maxSize = 50 * 1024 * 1024 // 50MB

if (storageSize > maxSize * 0.8) {
  alert('å†å²è®°å½•å­˜å‚¨ç©ºé—´å³å°†ç”¨å®Œï¼Œå»ºè®®æ¸…ç†æ—§è®°å½•')
}
```

## æ•°æ®è¿ç§»å’Œå¤‡ä»½

### å¯¼å‡ºå†å²è®°å½•

```typescript
async function exportHistory() {
  const items = await getHistory()
  const json = JSON.stringify(items, null, 2)
  const blob = new Blob([json], { type: 'application/json' })
  const url = URL.createObjectURL(blob)
  
  const a = document.createElement('a')
  a.href = url
  a.download = `history_${Date.now()}.json`
  a.click()
}
```

### å¯¼å…¥å†å²è®°å½•

```typescript
async function importHistory(file: File) {
  const text = await file.text()
  const items: HistoryItem[] = JSON.parse(text)
  
  for (const item of items) {
    await saveHistory(item)
  }
}
```

## æ€»ç»“

è¿™ä¸ªæ–¹æ¡ˆæä¾›äº†å®Œæ•´çš„å†å²è®°å½•åŠŸèƒ½ï¼š

âœ… **çº¯å‰ç«¯å®ç°**ï¼šä½¿ç”¨ IndexedDBï¼Œæ— éœ€æœåŠ¡å™¨  
âœ… **åŠŸèƒ½å®Œå–„**ï¼šæŸ¥çœ‹ã€æœç´¢ã€ç­›é€‰ã€åˆ é™¤ã€é‡æ–°ç”Ÿæˆ  
âœ… **æ€§èƒ½ä¼˜åŒ–**ï¼šç¼©ç•¥å›¾ã€æ‡’åŠ è½½ã€è™šæ‹Ÿæ»šåŠ¨  
âœ… **å­˜å‚¨ç®¡ç†**ï¼šè‡ªåŠ¨æ¸…ç†ã€å¯¼å‡ºå¤‡ä»½  
âœ… **ç”¨æˆ·ä½“éªŒ**ï¼šç›´è§‚çš„ UIã€æµç•…çš„äº¤äº’  

å¯ä»¥éƒ¨ç½²åœ¨ EdgeOne ç­‰ä»»ä½•é™æ€æ‰˜ç®¡æœåŠ¡ä¸Šï¼Œå®Œå…¨æ»¡è¶³éœ€æ±‚ã€‚
