# 经验教训

## 技术实现经验

### 1. IndexedDB 使用
**经验**：IndexedDB 适合存储大量图片数据
- 使用 `objectStore` 存储历史记录
- 每条记录包含完整的 Base64 图片数据
- 实现自动清理机制（保留最新 100 条）

**教训**：
- IndexedDB API 是异步的，需要正确处理 Promise
- 数据库版本升级需要在 `onupgradeneeded` 中处理
- 大量数据查询时注意性能优化

### 2. Canvas 遮罩绘制与 Inpainting
**经验**：实现一个功能完备的 Mask Editor 需要处理坐标系统转换。
- **双层设计**：底层 Canvas/Img 显示原图，上层 Canvas 绘制遮罩（透明背景）。
- **坐标转换**：当 Canvas 被 CSS 缩放（Zoom）时，鼠标事件的 `clientX/Y` 需要映射回 Canvas 的内部像素坐标。公式：`x = (clientX - rect.left) * (canvas.width / rect.width)`。
- **遮罩导出**：Gemini API 需要黑底白形的遮罩图。在导出时，创建一个临时的 Canvas，先填充黑色，再绘制用户的遮罩（白色），然后导出 Base64。
- **Prompt 工程**：仅提供 Mask 图片是不够的，必须在 Prompt 中明确指示模型“保持黑色区域不变，重绘白色区域”。

### 3. 图片拖拽排序
**经验**：使用原生 HTML5 拖拽 API 实现
- `draggable` 属性启用拖拽
- `onDragStart/Over/End` 事件处理
- 实时更新数组顺序提供流畅体验

### 4. 全局粘贴监听
**经验**：支持全局粘贴图片提升用户体验
- 使用 `window.addEventListener('paste')` 监听全局粘贴事件
- 从 `ClipboardEvent` 中提取图片数据
- 在组件卸载时清理事件监听器

### 5. API Key 安全显示
**经验**：格式化显示 API Key 保护隐私
- 显示首尾各 6 个字符
- 中间用点号（•）替代
- 提供显示/隐藏切换按钮

### 6. UI 风格升级 (Glassmorphism + Tailwind)
**经验**：现代化的 UI 设计能显著提升用户体验
- **Tailwind CSS**: 极大地加快了样式开发速度，特别是在处理响应式和深色模式时。
- **Glassmorphism**: 通过 `backdrop-blur` 和半透明背景 (`bg-white/5`) 营造高级感。
- **工具类封装**: 将常用的玻璃拟态样式封装为 `.glass-card` 等工具类，保持代码整洁。

## 架构决策

### 1. 单组件架构
**决策**：主要逻辑集中在 `App.tsx`
**原因**：
- 应用规模较小
- 状态共享频繁
- 避免过度工程化

### 2. 无后端架构
**决策**：纯前端应用，直接调用 Gemini API
**优势**：部署简单，无服务器成本
**劣势**：API Key 暴露，无法实现复杂服务端逻辑

### 3. Base64 图片处理
**决策**：使用 Base64 编码处理图片
**原因**：Gemini API 要求 Base64 格式，简化前端处理流程
**权衡**：Base64 增加约 33% 数据量，但避免了文件上传的复杂性

## UI/UX 经验

### 1. 加载状态反馈
**经验**：提供清晰的加载状态（动画、禁用按钮、计时）能有效缓解用户焦虑。

### 2. 错误处理
**经验**：始终捕获异步操作的错误并显示给用户，而不是默默失败。

### 3. 响应式设计
**经验**：使用 Flexbox 和 Grid 布局，并针对移动端进行适配（虽然主要针对桌面端优化）。

## 待解决问题

### 1. 大图片性能
**问题**：4K 图片的 Base64 编码和存储可能较慢，且 Canvas 处理大图可能导致卡顿。
**可能方案**：Web Worker 处理编码，使用 OffscreenCanvas。

### 2. 移动端体验
**问题**：Canvas 绘图在移动端（触摸屏）的体验不如鼠标精准。
**改进方向**：优化触摸事件处理，增加手势缩放支持。

## 最佳实践总结
1. **状态管理**：合理使用 useState 和 useMemo。
2. **错误处理**：始终捕获异步操作的错误。
3. **Canvas 开发**：注意坐标系转换和性能（避免频繁 `putImageData`）。
4. **Prompt 工程**：对于复杂任务（如 Inpainting），Prompt 的质量直接决定结果。
